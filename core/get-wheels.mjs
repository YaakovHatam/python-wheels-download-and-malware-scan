import * as fs from 'fs';
import { execSync } from 'child_process';
import { EOL } from 'os';

function getWheelsModule(DONE_WHEELS_TEXT_FILE, WHEELS_DIR) {
    const command = (dest, packageName) => `py -m pip download --only-binary=:all: --platform manylinux1_x86_64  --python-version 3.8.5 --implementation cp --dest ${dest} ${packageName}`;

    const executeDownloadCommand = (f) => {
        console.log(f);
        return execSync(command(WHEELS_DIR, f));
    }

    const downloadDeps = () => {
        const filenames = fs.readdirSync(WHEELS_DIR);

        const doneWheels = fs.readFileSync(DONE_WHEELS_TEXT_FILE).toString().split(EOL);

        filenames.forEach((filename, idx) => {
            if (doneWheels.indexOf(filename) === -1) {
                const result = executeDownloadCommand(filename.split('-')[0]);

                if (result.toString("utf8").indexOf('Successfully') > -1) {
                    fs.appendFileSync(DONE_WHEELS_TEXT_FILE, filename + EOL);
                    console.log(result.toString("utf8"));
                }
            }
        });
    }

    return { downloadDeps, executeDownloadCommand };
}


export default getWheelsModule;