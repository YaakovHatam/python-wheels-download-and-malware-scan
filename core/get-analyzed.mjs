import { join } from 'path';
import { readFileSync, readdirSync, writeFileSync } from 'fs';


function analyzeResults(DIRS, FILES, HTMLS) {

    const rows = [];
    const reportFiles = readdirSync(DIRS.SCAN_RESULTS_DIR);


    reportFiles.forEach(rf => {
        const fileContent = JSON.parse(readFileSync(join(DIRS.SCAN_RESULTS_DIR, rf)).toString());
        rows.push({
            name: fileContent.data.attributes.meaningful_name,
            totalCleanStats: Object.keys(fileContent.data.attributes.last_analysis_results).filter(lar => fileContent.data.attributes.last_analysis_results[lar].category === "undetected").length,
            malicious: fileContent.data.attributes.last_analysis_stats.malicious
        })
    });

    const rowsHTML = rows.map(r => `<tr>
        <td class="column1">${r.name}</td>
        <td class="column2">${r.totalCleanStats}</td>
        <td class="column3">${r.malicious}</td>
        <td class="column4"></td>
        <td class="column5"></td>
        <td class="column6"></td>
    </tr>`);

    const htmlFile = readFileSync(HTMLS.HTML_TEMPLATE).toString()

    writeFileSync(HTMLS.HTML_RESULTS, htmlFile.replace('{{rows}}', rowsHTML.join('')));
}

export { analyzeResults }